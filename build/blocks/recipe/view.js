(()=>{"use strict";class e{constructionDate=new Date;ratingInProgress=!1;constructor(e){this.ratingElement=e;const t=e.getAttribute("data-post-id")||null;t&&(this.initEvents(),this.hasSavedRating(t)?this.hideRating():e.querySelectorAll(".recipe-creator--recipe-block--star").forEach((e=>{e.addEventListener("click",(r=>{const i=new Date;if(Math.abs(this.constructionDate.getTime()-i.getTime())<2e3)return;if(this.ratingInProgress)return;if(this.hasSavedRating(t))return;this.ratingInProgress=!0;const a=e.getAttribute("data-rating");a&&window.RecipeCreatorEventManager.emit("recipe-creator:rating-clicked",{postId:t,rating:+a})}))})))}hasSavedRating(e){return!!window.localStorage.getItem("recipe-creator::"+e)}initEvents(){window.RecipeCreatorEventManager.on("recipe-creator:rating-clicked",(async e=>{window.localStorage.setItem("recipe-creator::"+e.postId,""+e.rating);const t=await this.storeRatingInDatabase(e.postId,e.rating);window.RecipeCreatorEventManager.emit("recipe-creator:recipe-rated",{...e,...t})})),window.RecipeCreatorEventManager.on("recipe-creator:recipe-rated",(e=>{if(e.averageRating){const t=this.ratingElement.querySelector(".recipe-creator--recipe-block--average-voting");t&&(t.innerHTML=""+e.averageRating)}const t=this.ratingElement.querySelector('.recipe-creator--recipe-block--star[data-rating="'+e.rating+'"]');t&&this.markAsSelected(t),this.ratingElement.classList.remove("recipe-creator--recipe-block--interactive"),this.ratingInProgress=!1}))}hideRating(){const e=this.ratingElement?.closest(".recipe-creator--recipe-block--user-rating");e&&(e.style.display="none")}storeRatingInDatabase(e,t){return new Promise(((r,i)=>fetch(window.recipeCreatorConfig.ajaxUrl,{method:"POST",body:new URLSearchParams({_ajax_nonce:window.recipeCreatorConfig.nonce,action:"recipe_creator_set_rating",postId:e,rating:""+t})}).then((async e=>{if(400===e.status)return;const t=await e.json();r({averageRating:t?.data?.averageRating||0})})).catch((e=>{console.error(e),i()}))))}markAsSelected(e){let t=!1;const r=e.parentElement?.children;if(r)for(let i of r)i===e?(i.classList.add("selected"),t=!0):t?t&&i.classList.remove("selected"):i.classList.add("selected")}}class t{constructor(e){this.element=e,this.initRating(),this.element.dispatchEvent(new CustomEvent("recipe-creator:recipe-ready",{bubbles:!0}))}initRating(){const t=this.element.querySelectorAll(".recipe-creator--recipe-block--rating.recipe-creator--recipe-block--interactive");t&&t.forEach((t=>{new e(t)}))}}window.RecipeCreatorEventManager=new class{events={};on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}off(e,t){this.events[e]&&(this.events[e]=this.events[e].filter((e=>e!==t)))}overwrite(e,t){this.events[e]=[t]}emit(e,t){this.events[e]&&this.events[e].forEach((e=>e(t)))}},document.addEventListener("DOMContentLoaded",(function(){document.querySelectorAll(".recipe-creator--recipe-block").forEach((e=>new t(e)))}))})();